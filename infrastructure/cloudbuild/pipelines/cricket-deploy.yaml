# Cloud Build Pipeline for Cricket Services Deployment
# Deploys cricket-agent and cricket-bridge services

steps:
  # Check if Cricket Agent image already exists
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk:slim'
    id: 'check-cricket-agent-image'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        set -euo pipefail
        if gcloud artifacts docker images describe "${_REGION}-docker.pkg.dev/${_PROJECT_ID}/${_ARTIFACT_REPO}/cricket-agent:${BUILD_ID}" >/dev/null 2>&1; then
          echo "Cricket Agent image already exists, skipping build"
          echo "{\"action\": \"check_image\", \"status\": \"exists\"}"
        else
          echo "Cricket Agent image not found, will build"
          echo "{\"action\": \"check_image\", \"status\": \"not_found\"}"
        fi
    waitFor: ['-']

  # Build and Deploy Cricket Agent (only if image doesn't exist)
  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-cricket-agent'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        set -euo pipefail
        if gcloud artifacts docker images describe "${_REGION}-docker.pkg.dev/${_PROJECT_ID}/${_ARTIFACT_REPO}/cricket-agent:${BUILD_ID}" >/dev/null 2>&1; then
          echo "Skipping build - image already exists"
          exit 0
        fi
        echo "Building Cricket Agent image"
        docker build -t "${_REGION}-docker.pkg.dev/${_PROJECT_ID}/${_ARTIFACT_REPO}/cricket-agent:${BUILD_ID}" -t "${_REGION}-docker.pkg.dev/${_PROJECT_ID}/${_ARTIFACT_REPO}/cricket-agent:latest" services/cricket-agent
    waitFor: ['check-cricket-agent-image']

  - name: 'gcr.io/cloud-builders/docker'
    id: 'push-cricket-agent'
    args:
      - 'push'
      - '--all-tags'
      - '${_REGION}-docker.pkg.dev/${_PROJECT_ID}/${_ARTIFACT_REPO}/cricket-agent'
    waitFor: ['build-cricket-agent']

  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk:slim'
    id: 'deploy-cricket-agent'
    entrypoint: 'gcloud'
    args:
      - 'run'
      - 'deploy'
      - 'cricket-agent'
      - '--image'
      - '${_REGION}-docker.pkg.dev/${_PROJECT_ID}/${_ARTIFACT_REPO}/cricket-agent:${BUILD_ID}'
      - '--region'
      - '${_REGION}'
      - '--platform'
      - 'managed'
      - '--allow-unauthenticated'
      - '--service-account'
      - 'sa-cricket-agent@${_PROJECT_ID}.iam.gserviceaccount.com'
      - '--set-env-vars'
      - 'APP_ENV=prod,GCP_PROJECT=${_PROJECT_ID},REGION=${_REGION},VERTEX_LOCATION=${_REGION},VERTEX_MODEL=gemini-1.5-flash,EMBED_MODEL=text-embedding-005,PLAYHQ_MODE=public,VECTOR_BACKEND=vertex_rag'
      - '--set-secrets'
      - 'SECRET_PLAYHQ_API_KEY=SECRET_PLAYHQ_API_KEY:latest,SECRET_IDS_BUNDLE=CSCC_IDS:latest,SECRET_INTERNAL_TOKEN=CRICKET_INTERNAL_TOKEN:latest'
      - '--memory'
      - '1Gi'
    waitFor: ['push-cricket-agent']

  # Skip Cricket Bridge - already deployed and running
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk:slim'
    id: 'skip-cricket-bridge'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "Skipping Cricket Bridge build - service is already deployed and running"
        echo "{\"action\": \"skip_bridge\", \"status\": \"already_deployed\"}"
    waitFor: ['-']

  # Write deployment state
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk:slim'
    id: 'write-deployment-state'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        set -euo pipefail
        
        # Get service URLs
        AGENT_URL=$$(gcloud run services describe cricket-agent --region ${_REGION} --format='value(status.url)')
        
        # Cricket Bridge is already deployed, get its URL
        if BRIDGE_URL=$$(gcloud run services describe cricket-bridge --region ${_REGION} --format='value(status.url)' 2>/dev/null); then
          echo "Bridge URL found: $$BRIDGE_URL"
        else
          BRIDGE_URL="https://cricket-bridge-621175176615.australia-southeast1.run.app"
          echo "Using known Bridge URL: $$BRIDGE_URL"
        fi
        
        # Create deployment state JSON
        cat > /tmp/deployment-state.json << JSONEOF
        {
          "deployment": {
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "build_id": "${BUILD_ID}",
            "short_sha": "${BUILD_ID}",
            "project_id": "${_PROJECT_ID}",
            "region": "${_REGION}",
            "services": {
              "cricket-agent": {
                "url": "$$AGENT_URL",
                "image": "${_REGION}-docker.pkg.dev/${_PROJECT_ID}/${_ARTIFACT_REPO}/cricket-agent:${BUILD_ID}"
              },
              "cricket-bridge": {
                "url": "$$BRIDGE_URL",
                "image": "${_REGION}-docker.pkg.dev/${_PROJECT_ID}/${_ARTIFACT_REPO}/cricket-bridge:${BUILD_ID}"
              }
            }
          }
        }
        JSONEOF
        
        
        # Upload to GCS
        gsutil cp /tmp/deployment-state.json gs://anzx-deploy-state/state/deploy-${BUILD_ID}.json
        
        echo '{"action": "write_deployment_state", "status": "success", "file": "deploy-'${BUILD_ID}'.json"}'
    waitFor: ['deploy-cricket-agent', 'skip-cricket-bridge']

# Global substitutions with defaults
substitutions:
  _PROJECT_ID: 'virtual-stratum-473511-u5'
  _REGION: 'australia-southeast1'
  _ARTIFACT_REPO: 'anzx-agents'

options:
  logging: CLOUD_LOGGING_ONLY
  substitutionOption: 'ALLOW_LOOSE'

timeout: '1800s'  # 30 minutes